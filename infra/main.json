{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.9.1.41621",
      "templateHash": "16896013452934789008"
    }
  },
  "parameters": {
    "skuName": {
      "type": "string",
      "defaultValue": "S1"
    },
    "skuCapacity": {
      "type": "int",
      "defaultValue": 1
    },
    "servicePlan": {
      "type": "string",
      "defaultValue": "contosoasp"
    },
    "appName": {
      "type": "string",
      "defaultValue": "contosoapp"
    },
    "apiName": {
      "type": "string",
      "defaultValue": "contosoapi"
    },
    "insightName": {
      "type": "string",
      "defaultValue": "contosoai"
    },
    "analyticsName": {
      "type": "string",
      "defaultValue": "contosola"
    },
    "location": {
      "type": "string",
      "defaultValue": "eastus"
    },
    "serverName": {
      "type": "string",
      "defaultValue": "contosodbserver"
    },
    "databaseName": {
      "type": "string",
      "defaultValue": "contosodb"
    }
  },
  "variables": {
    "appServicePlanName": "[toLower(parameters('servicePlan'))]",
    "webSiteName": "[toLower(parameters('appName'))]",
    "webApiName": "[toLower(parameters('apiName'))]",
    "resourceGroupName": "rgContosoDemo",
    "appInsightName": "[toLower(parameters('insightName'))]",
    "logAnalyticsName": "[toLower(parameters('analyticsName'))]",
    "sqlserverName": "[toLower(parameters('serverName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[variables('resourceGroupName')]",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "resources",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appServicePlanName": {
            "value": "[variables('appServicePlanName')]"
          },
          "skuCapacity": {
            "value": "[parameters('skuCapacity')]"
          },
          "skuName": {
            "value": "[parameters('skuName')]"
          },
          "databaseName": {
            "value": "[parameters('databaseName')]"
          },
          "webSiteName": {
            "value": "[variables('webSiteName')]"
          },
          "webApiName": {
            "value": "[variables('webApiName')]"
          },
          "serverName": {
            "value": "[variables('sqlserverName')]"
          },
          "appinsightsname": {
            "value": "[variables('appInsightName')]"
          },
          "loganalyticsname": {
            "value": "[variables('logAnalyticsName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.9.1.41621",
              "templateHash": "9427405677078146581"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appServicePlanName": {
              "type": "string"
            },
            "skuName": {
              "type": "string"
            },
            "skuCapacity": {
              "type": "int"
            },
            "webSiteName": {
              "type": "string"
            },
            "webApiName": {
              "type": "string"
            },
            "serverName": {
              "type": "string"
            },
            "databaseName": {
              "type": "string"
            },
            "appinsightsname": {
              "type": "string"
            },
            "loganalyticsname": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2020-06-01",
              "name": "[parameters('appServicePlanName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('skuName')]",
                "capacity": "[parameters('skuCapacity')]"
              },
              "tags": {
                "displayName": "HostingPlan",
                "ProjectName": "ContosoUniversity",
                "appTemplateName": "dotnetweb"
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2020-06-01",
              "name": "[parameters('webSiteName')]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "tags": {
                "displayName": "Website",
                "ProjectName": "ContosoUniversity"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
                "httpsOnly": true,
                "siteConfig": {
                  "minTlsVersion": "1.2"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/logs', parameters('webSiteName'))]",
              "properties": {
                "applicationLogs": {
                  "fileSystem": {
                    "level": "Warning"
                  }
                },
                "httpLogs": {
                  "fileSystem": {
                    "retentionInMb": 40,
                    "enabled": true
                  }
                },
                "failedRequestsTracing": {
                  "enabled": true
                },
                "detailedErrorMessages": {
                  "enabled": true
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('webSiteName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}/{1}', parameters('webSiteName'), 'appsettings')]",
              "properties": {
                "APPINSIGHTS_INSTRUMENTATIONKEY": "[reference(resourceId('Microsoft.Resources/deployments', 'applicationinsights-resources')).outputs.APPLICATIONINSIGHTS_INSTRUMENTATIONKEY.value]",
                "APPLICATIONINSIGHTS_CONNECTION_STRING": "[reference(resourceId('Microsoft.Resources/deployments', 'applicationinsights-resources')).outputs.APPLICATIONINSIGHTS_CONNECTION_STRING.value]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'applicationinsights-resources')]",
                "[resourceId('Microsoft.Web/sites', parameters('webSiteName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2020-06-01",
              "name": "[parameters('webApiName')]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "tags": {
                "displayName": "Website",
                "ProjectName": "ContosoUniversity"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
                "httpsOnly": true,
                "siteConfig": {
                  "minTlsVersion": "1.2"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/logs', parameters('webApiName'))]",
              "properties": {
                "applicationLogs": {
                  "fileSystem": {
                    "level": "Warning"
                  }
                },
                "httpLogs": {
                  "fileSystem": {
                    "retentionInMb": 40,
                    "enabled": true
                  }
                },
                "failedRequestsTracing": {
                  "enabled": true
                },
                "detailedErrorMessages": {
                  "enabled": true
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('webApiName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}/{1}', parameters('webApiName'), 'appsettings')]",
              "properties": {
                "AZURE_SQL_CONNECTION_STRING": "[format('Server={0}; Authentication=Active Directory Default; Database={1};', reference(resourceId('Microsoft.Sql/servers', parameters('serverName'))).fullyQualifiedDomainName, parameters('databaseName'))]",
                "APPINSIGHTS_INSTRUMENTATIONKEY": "[reference(resourceId('Microsoft.Resources/deployments', 'applicationinsights-resources')).outputs.APPLICATIONINSIGHTS_INSTRUMENTATIONKEY.value]",
                "APPLICATIONINSIGHTS_CONNECTION_STRING": "[reference(resourceId('Microsoft.Resources/deployments', 'applicationinsights-resources')).outputs.APPLICATIONINSIGHTS_CONNECTION_STRING.value]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('webApiName'))]",
                "[resourceId('Microsoft.Resources/deployments', 'applicationinsights-resources')]",
                "[resourceId('Microsoft.Sql/servers', parameters('serverName'))]"
              ]
            },
            {
              "type": "Microsoft.Sql/servers",
              "apiVersion": "2021-02-01-preview",
              "name": "[parameters('serverName')]",
              "location": "[parameters('location')]",
              "tags": {
                "displayName": "SQL Server",
                "ProjectName": "ContosoUniversity"
              },
              "properties": {
                "version": "12.0",
                "minimalTlsVersion": "1.2",
                "publicNetworkAccess": "Enabled",
                "administrators": {
                  "administratorType": "ActiveDirectory",
                  "principalType": "User",
                  "sid": "[reference(resourceId('Microsoft.Web/sites', parameters('webApiName')), '2020-06-01', 'full').identity.principalId]",
                  "login": "activedirectoryadmin",
                  "tenantId": "[reference(resourceId('Microsoft.Web/sites', parameters('webApiName')), '2020-06-01', 'full').identity.tenantId]",
                  "azureADOnlyAuthentication": true
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('webApiName'))]"
              ]
            },
            {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2021-02-01-preview",
              "name": "[format('{0}/{1}', parameters('serverName'), parameters('databaseName'))]",
              "location": "[parameters('location')]",
              "tags": {
                "displayName": "Database",
                "ProjectName": "ContosoUniversity"
              },
              "sku": {
                "name": "Basic"
              },
              "properties": {
                "collation": "SQL_Latin1_General_CP1_CI_AS",
                "maxSizeBytes": 1073741824
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('serverName'))]"
              ]
            },
            {
              "type": "Microsoft.Sql/servers/firewallRules",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('serverName'), 'AllowAllWindowsAzureIps')]",
              "properties": {
                "endIpAddress": "0.0.0.0",
                "startIpAddress": "0.0.0.0"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('serverName'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "applicationinsights-resources",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "analyticsName": {
                    "value": "[parameters('loganalyticsname')]"
                  },
                  "insightName": {
                    "value": "[parameters('appinsightsname')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.9.1.41621",
                      "templateHash": "3998044734565194949"
                    }
                  },
                  "parameters": {
                    "insightName": {
                      "type": "string"
                    },
                    "analyticsName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "appInsightName": "[toLower(parameters('insightName'))]",
                    "logAnalyticsName": "[toLower(parameters('analyticsName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.OperationalInsights/workspaces",
                      "apiVersion": "2020-03-01-preview",
                      "name": "[variables('logAnalyticsName')]",
                      "location": "[parameters('location')]",
                      "tags": {
                        "displayName": "Log Analytics",
                        "ProjectName": "ContosoUniversity",
                        "appTemplateName": "dotnetweb"
                      },
                      "properties": {
                        "sku": {
                          "name": "PerGB2018"
                        },
                        "retentionInDays": 120
                      }
                    },
                    {
                      "type": "Microsoft.Insights/components",
                      "apiVersion": "2020-02-02-preview",
                      "name": "[variables('appInsightName')]",
                      "location": "[parameters('location')]",
                      "kind": "string",
                      "tags": {
                        "displayName": "AppInsight",
                        "ProjectName": "ContosoUniversity",
                        "appTemplateName": "dotnetweb"
                      },
                      "properties": {
                        "Application_Type": "web",
                        "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "APPLICATIONINSIGHTS_CONNECTION_STRING": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightName'))).ConnectionString]"
                    },
                    "APPLICATIONINSIGHTS_INSTRUMENTATIONKEY": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightName'))).InstrumentationKey]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "APPLICATIONINSIGHTS_CONNECTION_STRING": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'applicationinsights-resources')).outputs.APPLICATIONINSIGHTS_CONNECTION_STRING.value]"
            },
            "sqlconnectionstring": {
              "type": "string",
              "value": "[format('Server={0}; Authentication=Active Directory Default; Database={1};', reference(resourceId('Microsoft.Sql/servers', parameters('serverName'))).fullyQualifiedDomainName, parameters('databaseName'))]"
            },
            "appServicePlanId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
            },
            "WEB_URI": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('webSiteName'))).defaultHostName)]"
            },
            "API_URI": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('webApiName'))).defaultHostName)]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    }
  ],
  "outputs": {
    "AZURE_SQL_CONNECTION_STRING": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'resources')).outputs.sqlconnectionstring.value]"
    },
    "APPLICATIONINSIGHTS_CONNECTION_STRING": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'resources')).outputs.APPLICATIONINSIGHTS_CONNECTION_STRING.value]"
    },
    "WEB_BASE_URL": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'resources')).outputs.WEB_URI.value]"
    },
    "API_BASE_URL": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'resources')).outputs.API_URI.value]"
    },
    "AZURE_LOCATION": {
      "type": "string",
      "value": "[parameters('location')]"
    }
  }
}